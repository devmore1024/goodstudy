# A3b 家长建档对话

## 页面信息
- **所属模块**：登录注册模块
- **页面类型**：全屏页
- **数字人老师**：大/居中
- **支持模式**：家长

## 线框图

```
+----------------------------------------+
|  9:41            ⚡ 📶 100%            |
| ←                              跳过    |
|                                        |
|           +------------+               |
|           |   数字人   |               |
|           |   老师     |               |
|           |  (上半身)  |               |
|           | 160x200pt  |               |
|           +------------+               |
|                                        |
|  +------------------------------------+|
|  | 🌸 欢迎家长！我是小花老师~        ||
|  |   请问您是孩子的爸爸、妈妈，      ||
|  |   还是其他家人呢？                ||
|  +------------------------------------+|
|                                        |
|  +------------------------------------+|
|  |  请选择您的身份                     ||
|  |  +--------+ +--------+ +--------+ ||
|  |  | 爸爸   | | 妈妈   | |其他家人| ||
|  |  +--------+ +--------+ +--------+ ||
|  +------------------------------------+|
|                                        |
|  +------------------------------------+|
|  | 🌸 好的妈妈，接下来请您说几句话   ||
|  |   让我记住您的声音~                ||
|  +------------------------------------+|
|                                        |
|  +------------------------------------+|
|  | 已注册的孩子：                      ||
|  | +--------------------------------+ ||
|  | | 👦 小明  三年级  已关联 ✓       | ||
|  | +--------------------------------+ ||
|  | +--------------------------------+ ||
|  | | 👧 小红  五年级  点击关联       | ||
|  | +--------------------------------+ ||
|  | +--------------------------------+ ||
|  | | ＋ 添加新的孩子                 | ||
|  | +--------------------------------+ ||
|  +------------------------------------+|
|                                        |
|  +------------------------------------+|
|  | 🌸 我帮您整理好了，请确认一下~    ||
|  |                                    ||
|  | +--------------------------------+ ||
|  | | 家长档案信息                     | ||
|  | | ─────────────────────────────── | ||
|  | | 身份      妈妈                  | ||
|  | | 声纹      已录入 ✓              | ||
|  | | 关联孩子                         | ||
|  | |   小明(三年级)  声纹 ✓          | ||
|  | |   小红(五年级)  声纹未录入      | ||
|  | | ─────────────────────────────── | ||
|  | | +------------+ +--------------+ | ||
|  | | | 我要修改   | |  确认无误    | | ||
|  | | +------------+ +--------------+ | ||
|  | +--------------------------------+ ||
|  +------------------------------------+|
|                                        |
|  ◉ 声纹采集 ████████████ 100% ✓       |
|                                        |
|          +--------------------+        |
|          |  🎤 按住说话       |        |
|          +--------------------+        |
|                                        |
+----------------------------------------+
```

## 元素说明

### 1. 导航栏
- **位置**：页面顶部
- **左侧**：返回箭头，点击返回 A3 重新选择身份
- **右侧**：「跳过」文字按钮，字号 14pt，颜色 #999999
- **样式**：透明背景

### 2. 数字人老师形象
- **位置**：导航栏下方居中
- **初始尺寸**：96 × 96 pt 圆形（upper 模式），白色描边 ring-3、阴影 shadow-xl、半透明光晕
- **缩小后**：40 × 40 pt 圆形（avatar 模式），白色描边 ring-2、阴影 shadow-md
- **内容**：小花老师真实卡通头像图片（`/images/teacher.png`）
- **说明**：用户首次回答后，头像自动缩小至 avatar 模式以留出更多对话空间
- **背景**：页面使用 page-bg-chat 渐变背景，带半透明装饰圆形

### 3. 对话消息列表
- **位置**：数字人形象下方
- **布局**：同 A3a，垂直滚动聊天界面
- **AI 消息**：左对齐，白色气泡，小花头像
- **用户消息**：右对齐，品牌浅色气泡
- **样式规范**：同 A3a 页面

### 4. 家长身份选择器
- **触发**：AI 询问家长身份后嵌入对话流中
- **位置**：嵌入在 AI 对话气泡内
- **布局**：3 列网格，间距 12pt
- **选项**：
  - 「爸爸」：默认选项样式
  - 「妈妈」：默认选项样式
  - 「其他家人」：默认选项样式
- **每个选项样式**：
  - 默认：白色背景，圆角 8pt，1px 边框 #E5E5E5，字号 14pt，高 40pt
  - 选中：品牌色背景 #FF7A45，白色文字，轻微弹跳动画
- **「其他家人」交互**：选择后弹出文字输入框，placeholder「请输入称呼（如爷爷、奶奶、外公等）」，可自行填写称呼
- **语音交互**：也可通过语音回答「我是孩子的爸爸/妈妈/爷爷」等
- **选择后效果**：AI 使用对应称呼进行后续对话，如「好的妈妈，接下来...」

### 5. 已注册孩子列表卡片
- **触发**：AI 询问孩子信息后，后台查询同一手机号下的学生账号，嵌入对话流
- **位置**：嵌入对话气泡中
- **样式**：白色卡片，圆角 12pt
- **标题**：「已注册的孩子：」，字号 14pt，颜色 #666666

#### 孩子列表项
- **尺寸**：宽度充满卡片，高 56pt
- **布局**：左侧头像 + 中间信息 + 右侧状态
- **头像**：40 × 40 pt 圆形，默认头像或用户上传头像
- **信息区**：
  - 姓名：字号 16pt，字重 Medium，颜色 #333333
  - 年级：字号 13pt，颜色 #999999
  - 声纹状态：字号 12pt，已采集显示绿色「声纹已录入」，未采集显示橙色「声纹未录入」
- **状态区**：
  - 已关联：绿色对勾 + 「已关联」文字，颜色 #52C41A
  - 未关联：品牌色文字「点击关联」，可点击
- **分隔线**：项之间 1px #F0F0F0 分隔线

#### 添加新孩子入口
- **位置**：孩子列表最后一项
- **尺寸**：同列表项
- **样式**：虚线边框 1px #D9D9D9，圆角 8pt
- **内容**：「+」图标 + 「添加新的孩子」文字，颜色 #999999
- **交互**：点击后进入添加孩子子流程

### 6. 档案确认卡片
- **触发**：孩子关联/添加流程完成后，嵌入对话气泡中
- **位置**：嵌入在 AI 对话气泡内
- **样式**：白色卡片，圆角 12pt，内边距 16pt
- **内容**：
  - 标题：「家长档案信息」，字号 16pt，字重 Medium，颜色 #333333
  - 分隔线：1px #F0F0F0
  - 信息行（每行）：
    - 标签：字号 13pt，颜色 #999999（如「身份」「声纹状态」「关联孩子」）
    - 值：字号 15pt，颜色 #333333
    - 行高 40pt，行间距 0
  - 声纹状态行：值显示绿色「已录入 ✓」，颜色 #52C41A
  - 关联孩子行：列出每个孩子姓名（年级），声纹已录入显示绿色 ✓，未录入显示橙色「未录入」
- **底部按钮**：
  - 两列等宽，间距 12pt
  - 「我要修改」：白色背景，品牌色文字，1px 品牌色边框，圆角 8pt，高 40pt
  - 「确认无误」：品牌色背景，白色文字，圆角 8pt，高 40pt
- **交互**：
  - 点击「确认无误」或语音说「没问题」→ 进入家庭注册状态检查
  - 点击「我要修改」→ AI 询问修改项，回到对应步骤

### 7. 声纹采集进度条
- **位置**：对话区域下方
- **样式**：同 A3 页面
- **说明**：延续 A3 采集进度，继续在对话中累积
- **完成态**：进度 100%，显示绿色对勾和「声纹已采集完成」

### 8. 底部固定输入栏（ChatInputBar）
- **位置**：页面底部固定
- **布局**：左侧语音/键盘切换按钮 + 中间输入区 + 右侧扩展按钮
- **文字模式**：圆角 16pt 输入框（placeholder「请输入...」）+ 品牌绿圆形发送按钮
- **语音模式**：「按住说话」按钮，按住后变为「松开发送」并高亮品牌色边框
- **切换按钮**：麦克风图标 / 键盘图标，36pt 圆形
- **背景**：毛玻璃效果（glass），顶部 1px 分隔线
- **显示条件**：当前步骤输入类型为 text 时显示；tag-select / voiceprint / child-list / card 等输入类型时隐藏

## 交互行为

### 手势交互
- **上下滑动**：滚动对话列表
- **按住说话**：长按语音按钮录音
- **上滑取消**：取消当前语音输入
- **点击身份选项**：选择家长身份（爸爸/妈妈/其他家人）
- **点击孩子列表项**：触发关联/取消关联操作
- **点击添加新孩子**：进入添加流程
- **左滑返回**：返回 A3（需确认）

### 输入交互
- **语音输入**：同 A3 的语音输入逻辑
- **文字输入**：可切换为键盘文字输入
- **身份选择**：点击选择或语音回答
- **关联操作**：
  - 点击「点击关联」：弹出确认弹窗「确认关联[姓名]的学习数据？」
  - 确认后：状态变为「已关联 ✓」
  - 取消关联：长按已关联的孩子，出现「取消关联」选项

### 动画与反馈
- **AI 消息出现**：同 A3a，气泡滑入 + 文字逐字显示
- **身份选择器展开**：从气泡内展开，高度由 0 过渡到完整高度，时长 300ms
- **身份选中**：选项轻微缩放弹跳 + 品牌色填充过渡
- **孩子列表展开**：从气泡内展开，列表项依次从左侧飞入，每项延迟 100ms
- **关联成功**：列表项轻微左右晃动 + 对勾图标弹出动画 + 绿色闪烁
- **关联成功全局反馈**：数字人竖大拇指 + 语音「太好了，关联成功！」
- **添加新孩子**：平滑展开输入表单或跳转子页面
- **档案确认卡片出现**：卡片从气泡内展开，信息行依次从上到下淡入，每行延迟 100ms
- **建档完成**：同 A3a 的完成动画

### AI 老师交互

#### 对话流程
1. **欢迎语**：「欢迎家长！我是小花老师，很荣幸能协助您管理孩子的学习。我会定期向您汇报孩子的学习情况~」
   - 数字人微微鞠躬

2. **家长身份选择**：「请问您是孩子的爸爸、妈妈，还是其他家人呢？」
   - 展示身份选择器（嵌入对话气泡）：爸爸 / 妈妈 / 其他家人
   - 选择「其他家人」时弹出文字输入框，可自行填写称呼
   - 选择后 AI 确认：「好的[称呼]，接下来...」
   - 后续对话中 AI 统一使用对应称呼

3. **声纹采集提示**：「为了方便识别您的身份，请您说几句话让我记住您的声音~」
   - 若从 A3 带来的声纹进度已足够，跳过此步
   - 未完成时引导家长说话，如「请说说您对孩子学习的期望」

4. **查询已注册孩子**：「让我看看您家是否有孩子已经在使用小花老师...」
   - 后台根据手机号查询关联学生账号
   - 有结果时展示孩子列表卡片
   - 无结果时询问「看起来还没有孩子注册，需要我帮您添加一个吗？」

5. **已有孩子情况**：
   - 显示已注册孩子列表
   - AI 引导：「请点击选择您要关联的孩子，这样您就能看到他们的学习报告了~」
   - 关联成功后 AI 确认

6. **添加新孩子流程**：
   - 用户点击「添加新的孩子」
   - AI 询问：「新的小朋友叫什么名字呢？」
   - 后续收集：姓名、年级、城市（简化版 A3a 流程）
   - 完成后生成一个邀请码或链接
   - AI 说：「我给您生成了一个邀请码 [XXXX]，让孩子用这个码登录就能关联到您的账号了~」

7. **多孩子处理**：
   - 若有多个孩子，依次确认关联关系
   - AI 询问：「还有其他孩子需要添加吗？」
   - 用户回答「没有了」→ 进入档案确认

8. **档案确认**：
   - AI 提示：「我帮您整理好了，请确认一下信息~」
   - 在对话气泡中嵌入档案信息卡片，展示已收集的全部信息：
     - 身份：[称呼]（如妈妈、爸爸、爷爷等）
     - 声纹状态：已录入 ✓
     - 关联孩子：[孩子1姓名]（[年级]）、[孩子2姓名]（[年级]）...
     - 各孩子声纹状态：已录入 ✓ / 未录入
   - 卡片底部显示两个按钮：「确认无误」/「我要修改」
   - 用户点击「我要修改」→ AI 回应「没问题，您想修改哪一项呢？」→ 用户语音/点击指定字段 → 重新进入对应步骤
   - 用户点击「确认无误」或语音说「没问题」→ 进入第 9 步

9. **家庭注册状态检查**：
   - 检查关联的孩子中是否有至少一个完成了声纹录入
   - **情况 A：有孩子已完成声纹** → 家庭注册完成，AI 提示「太好了！家庭注册已完成，您现在可以查看孩子的学习情况了~」→ 显示「进入家长首页」按钮
   - **情况 B：没有孩子完成声纹** → AI 提示「家庭注册还差最后一步，需要孩子来录一下声纹哦~」
     - 显示两个选项按钮：
       - 「现在让孩子录入」→ 跳转孩子声纹采集流程
       - 「稍后再说」→ 进入家长首页（家庭注册待完成状态）

#### 身份纠错
- 对话中用户说「我其实是学生」，AI 识别后询问「你想切换到学生模式吗？」
- 用户确认后返回 A3，以学生身份重新进入 A3a 建档流程
- 顶部导航「返回」可回到 A3 重新进行身份判断

#### 声纹采集（家长声纹）
- 采集家长声纹以区分家庭成员身份
- 家长声纹与学生声纹分开存储
- 后续设备启动时，通过声纹自动识别当前使用者是家长还是学生
- 采集方式同 A3，需累计约 10 秒有效语音
- 家长声纹采集完成 ≠ 家庭注册完成（家庭注册完成需要孩子声纹）

## 状态枚举

### 默认状态
- 数字人老师居中展示，播放欢迎动画
- 自动开始对话流程
- 声纹进度延续 A3

### 空状态
- **无已注册孩子**：孩子列表卡片显示空状态插画 + 「还没有孩子注册」+ 「添加孩子」按钮
- **插画**：简笔画风格，一个空书包图案

### 加载状态
- **查询孩子中**：AI 气泡显示「正在查找...」+ 卡片区域显示骨架屏（3 行灰色占位条）
- **关联处理中**：被点击的列表项显示旋转加载图标替换状态文字
- **生成邀请码中**：AI 气泡显示「正在生成邀请码...」
- **建档提交中**：全屏半透明遮罩 + 「正在保存设置...」
- **家庭注册状态检查中**：AI 气泡显示「正在检查家庭注册状态...」

### 错误状态
- **查询孩子失败**：AI 回应「查询遇到问题，请检查网络后重试~」+ 「重试」按钮
- **关联失败**：列表项状态变为红色「关联失败」，AI 提示「关联遇到了问题，我们再试一次」
- **邀请码生成失败**：AI 提示「邀请码生成失败，请稍后再试」+ 重试
- **网络断开**：顶部红色横幅，对话功能受限
- **声纹采集失败**：提示可跳过，后续在设置中补充

### 边界情况
- **大量已注册孩子（> 5 个）**：列表展示前 5 个，底部显示「查看全部 N 个」展开按钮
- **孩子账号已被其他家长关联**：显示提示「该账号已关联其他家长，是否继续？」
- **重复关联**：已关联的孩子不可再次关联，显示已关联状态
- **对话中途退出**：保存已关联的关系，下次进入继续未完成步骤
- **家长不想关联任何孩子**：AI 提示「没关系，您可以之后在设置中关联孩子」，允许直接进入家长首页（家庭注册待完成状态）
- **邀请码有效期**：生成的邀请码 7 天有效，过期后需重新生成
- **跳过操作**：点击跳过，弹出确认弹窗「跳过后您可以在设置中关联孩子，是否继续？」
- **家长注册完成但无孩子声纹**：家长可进入家长首页，但顶部显示 banner 提醒「请让孩子完成声纹录入，以完成家庭注册」，部分功能可用（如查看学习报告等功能需孩子声纹录入后开放）

## 导航关系

### 从哪来
- A3 AI 老师欢迎对话页（确认家长身份后跳转）

### 到哪去
- **家庭注册完成（有孩子声纹）** → B2 家长首页
- **选择「稍后再说」** → B2 家长首页（家庭注册待完成状态，顶部 banner 提醒）
- **选择「现在让孩子录入」** → 孩子声纹采集流程
- **点击跳过** → B2 家长首页（无关联孩子状态）
- **点击返回** → A3 AI 老师欢迎对话页
- **添加新孩子详细流程** → 内联在当前对话中完成，不跳转新页面
