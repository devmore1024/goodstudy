# G4 网络异常状态

## 页面信息
- **所属模块**：全局组件（G 系列）
- **页面类型**：页面内嵌状态 / 浮层提示
- **数字人老师**：小/页面内居中显示（错误插图的一部分）
- **支持模式**：通用（学生模式与家长模式均可触发）

## 线框图

### 状态一：自动重试中（第 1~3 次）

```
┌──────────────────────────────────┐
│ ◀ 返回        页面标题      ...  │
│──────────────────────────────────│
│                                  │
│  ┌──────────────────────────┐    │
│  │                          │    │
│  │   （原页面内容区域）       │    │
│  │   （灰度 + 模糊处理）     │    │
│  │                          │    │
│  └──────────────────────────┘    │
│                                  │
│  ┌──────────────────────────┐    │
│  │                          │    │
│  │     ╭──────────────╮     │    │
│  │     │   WiFi 断裂   │     │    │
│  │     │   小动画图标   │     │    │
│  │     ╰──────────────╯     │    │
│  │                          │    │
│  │     网络连接出了问题      │    │
│  │     正在自动重试 (2/3)    │    │
│  │                          │    │
│  │     ◠ 旋转加载            │    │
│  │                          │    │
│  └──────────────────────────┘    │
│                                  │
│                                  │
└──────────────────────────────────┘
```

### 状态二：自动重试失败，手动重试

```
┌──────────────────────────────────┐
│ ◀ 返回        页面标题      ...  │
│──────────────────────────────────│
│                                  │
│                                  │
│                                  │
│         ┌──────────┐             │
│         │ 小花老师  │             │
│         │ (无奈叹气) │             │
│         └──────────┘             │
│                                  │
│     ╭────────────────────╮       │
│     │                    │       │
│     │   📡  断开连接      │       │
│     │   信号波纹消散动画  │       │
│     │                    │       │
│     ╰────────────────────╯       │
│                                  │
│       哎呀，网络开小差了          │
│       请检查你的网络连接          │
│                                  │
│       ┌──────────────────┐       │
│       │     点击重试      │       │
│       └──────────────────┘       │
│                                  │
│   ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─     │
│                                  │
│   你还可以查看这些离线内容：     │
│   ┌────────┐  ┌────────┐        │
│   │ 已缓存  │  │ 已缓存  │        │
│   │ 知识点1 │  │ 知识点2 │        │
│   └────────┘  └────────┘        │
│                                  │
└──────────────────────────────────┘
```

### 状态三：顶部 Toast 网络提示（弱网/恢复）

```
┌──────────────────────────────────┐
│ ┌──────────────────────────────┐ │
│ │ ⚠ 当前网络不稳定，部分功能   │ │
│ │   可能受影响                  │ │
│ └──────────────────────────────┘ │
│ ◀ 返回        页面标题      ...  │
│──────────────────────────────────│
│                                  │
│                                  │
│    （正常页面内容继续显示）        │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
└──────────────────────────────────┘
```

### 状态四：网络恢复 Toast

```
┌──────────────────────────────────┐
│ ┌──────────────────────────────┐ │
│ │ ✓ 网络已恢复                  │ │
│ └──────────────────────────────┘ │
│ ◀ 返回        页面标题      ...  │
│──────────────────────────────────│
│                                  │
│                                  │
│    （正常页面内容）               │
│    （自动刷新数据中...）          │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
│                                  │
└──────────────────────────────────┘
```

### 离线模式全屏状态

```
┌──────────────────────────────────┐
│ ◀ 返回        离线模式      ...  │
│──────────────────────────────────│
│ ┌──────────────────────────────┐ │
│ │  ⚠ 当前处于离线模式          │ │
│ └──────────────────────────────┘ │
│                                  │
│  可用功能：                       │
│  ┌──────────────────────────┐    │
│  │ ✓ 查看已缓存的知识点      │    │
│  │ ✓ 浏览已下载的学习内容    │    │
│  │ ✓ 查看历史学习记录        │    │
│  │ ✓ 查看已完成的练习题      │    │
│  └──────────────────────────┘    │
│                                  │
│  需要网络的功能：                  │
│  ┌──────────────────────────┐    │
│  │ ✗ AI 语音对话             │    │
│  │ ✗ 拍照识别/批改           │    │
│  │ ✗ 生成新练习题            │    │
│  │ ✗ 同步学习进度            │    │
│  │ ✗ 查看学习报告            │    │
│  └──────────────────────────┘    │
│                                  │
│  ┌────────────────────────────┐  │
│  │   已缓存内容               │  │
│  │   ┌──────┐ ┌──────┐       │  │
│  │   │知识点│ │知识点 │ ...   │  │
│  │   │ 分数 │ │ 方程 │       │  │
│  │   └──────┘ └──────┘       │  │
│  └────────────────────────────┘  │
│                                  │
└──────────────────────────────────┘
```

## 元素说明

| 元素 | 类型 | 说明 |
|------|------|------|
| 网络断裂图标 | Lottie 动画 | WiFi 图标断裂/信号消散动画，尺寸 80x80pt |
| 数字人形象 | 动态图像 | 尺寸 100x100pt，配合网络状态显示不同表情 |
| 错误标题文字 | 文字 | 字号 17pt，加粗，深色 |
| 错误说明文字 | 文字 | 字号 14pt，灰色 |
| 自动重试计数 | 文字 | 字号 13pt，灰色，格式"正在自动重试 (X/3)" |
| 重试按钮 | 主按钮 | 主题色填充，圆角 24px，宽度 200pt，高 48pt |
| 顶部 Toast 条 | 通知横幅 | 全宽，高 44pt，背景色：警告黄/成功绿 |
| 离线内容卡片 | 卡片列表 | 圆角 12px，浅灰背景，显示已缓存内容入口 |
| 可用功能列表 | 列表 | 绿色 ✓ 标记可离线使用功能 |
| 不可用功能列表 | 列表 | 红色 ✗ 标记需要网络的功能 |
| 模糊遮罩 | 背景处理 | 原页面内容高斯模糊 + 灰度处理，表示不可交互 |

## 交互行为

### 手势交互
- **点击重试按钮**：手动发起网络请求重试
- **下拉页面**：触发下拉刷新，等同于手动重试
- **点击离线内容卡片**：进入已缓存内容详情页
- **点击返回按钮**：返回上一页（如果上一页也无网络则继续显示异常状态）
- **顶部 Toast 向上滑动**：手动关闭 Toast 提示

### 输入交互
- 网络异常时禁用所有需要网络的输入操作（语音输入、拍照上传等）
- 文字输入框显示为禁用态，提示"需要网络连接"
- 离线可用功能的输入正常响应

### 动画与反馈

#### 网络断开动画
- WiFi 图标从满格逐渐断裂消散
- 动画时长 800ms，仅播放一次

#### 自动重试动画
- 旋转加载圈 + 计数器递增
- 每次重试间隔采用指数退避：第 1 次 2 秒，第 2 次 4 秒，第 3 次 8 秒
- 重试计数文字数字跳变带缩放动效

#### 网络恢复动画
- 顶部 Toast 从上方滑入，绿色背景
- 显示 2 秒后自动向上滑出消失
- 页面内容自动刷新，使用渐变过渡效果

#### 弱网提示动画
- 顶部 Toast 从上方滑入，黄色背景
- 持续显示直到网络恢复或用户手动关闭

#### 页面状态切换
- 正常态到异常态：淡入过渡 300ms
- 异常态到正常态：淡出异常内容 + 渐入正常内容，共 400ms

### AI 老师交互
- **自动重试中**：小花老师不显示（仅显示加载动画，避免干扰）
- **自动重试失败**：小花老师显示无奈/叹气表情，摊手动作
- **弱网提示**：小花老师在悬浮气泡中显示担心表情（仅气泡状态）
- **网络恢复**：小花老师悬浮气泡显示开心表情，持续 2 秒恢复默认
- **离线模式**：小花老师不显示（离线模式下 AI 功能不可用）

## 状态枚举

### 自动重试状态（第 1~3 次）
- 检测到网络异常后立即触发
- 页面原内容保持显示但模糊处理
- 显示重试计数和加载动画
- 采用指数退避策略：2s → 4s → 8s
- 用户无需操作，自动执行

### 手动重试状态（自动重试耗尽）
- 3 次自动重试均失败后进入
- 显示完整错误页面：插图 + 错误说明 + 重试按钮
- 下方显示离线可用内容
- 用户可点击重试或浏览离线内容

### 弱网状态
- 网络可连通但延迟高或带宽低
- 顶部黄色 Toast 提示
- 页面内容正常显示但可能加载缓慢
- 自动降级策略：关闭非必要的图片/动画加载

### 离线状态（完全无网络）
- 无任何网络连接（WiFi 和蜂窝数据均关闭）
- 全屏显示离线模式页面
- 展示可用功能和不可用功能清单
- 提供已缓存内容快捷入口

### 网络恢复状态
- 检测到网络恢复后自动触发
- 顶部绿色 Toast 提示"网络已恢复"
- 自动刷新当前页面数据
- 重新建立与服务器的连接
- 自动同步离线期间产生的本地数据

### 错误状态细分

| 错误类型 | 错误码 | 用户提示文案 | 处理策略 |
|----------|--------|-------------|---------|
| 无网络连接 | NO_NETWORK | 哎呀，网络开小差了 | 自动重试 3 次 + 手动重试 |
| DNS 解析失败 | DNS_ERROR | 网络连接出了问题 | 自动重试 3 次 + 手动重试 |
| 连接超时 | TIMEOUT | 网络太慢了，换个地方试试？ | 自动重试 2 次 + 手动重试 |
| 服务器错误 (5xx) | SERVER_ERROR | 服务器忙不过来了 | 自动重试 3 次 + 手动重试 |
| 请求被限流 (429) | RATE_LIMIT | 提问太快啦，休息一下 | 等待后自动重试 |
| SSL 证书错误 | SSL_ERROR | 网络环境不安全 | 不自动重试，提示检查网络 |

### 边界情况
- **页面加载一半断网**：已加载内容保持显示，未加载部分显示占位图 + 重试
- **上传过程中断网**：保存上传队列到本地，网络恢复后自动续传
- **AI 对话中断网**：保存已收到的部分回复，标记为"回复不完整"
- **多标签页断网**：全局网络状态管理，所有 Tab 同步显示网络异常
- **VPN/代理环境**：特殊网络环境下超时阈值放宽至 2 倍
- **飞行模式**：立即进入离线模式，跳过自动重试流程
- **WiFi 连接但无互联网**：检测实际连通性，而非仅检查连接状态
- **频繁断网重连**：防抖处理，3 秒内多次网络状态变化只响应最终状态

## 导航关系

### 从哪来
- **任意页面**：网络请求失败时自动触发（全局网络状态监听）
- **G3 加载处理状态**：加载过程中网络异常时切换至此状态
- **G1 语音交互浮层**：语音请求网络异常时触发浮层内错误提示
- **首次启动**：无网络状态下启动 App 时进入离线模式

### 到哪去
- **当前页面（正常态）**：网络恢复后自动刷新回到正常状态
- **离线内容详情页**：点击已缓存内容卡片进入
- **系统设置页**：特定错误提示中引导用户检查网络设置
- **上一页面**：用户点击返回
