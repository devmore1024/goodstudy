# G1 语音交互浮层

## 页面信息
- **所属模块**：全局组件（G 系列）
- **页面类型**：浮层
- **数字人老师**：大/居中（浮层内显示完整数字人形象）
- **支持模式**：通用（学生模式与家长模式均可触发）

## 线框图

### 状态一：唤醒态（Wake）

```
┌──────────────────────────────────┐
│          （当前页面内容）          │
│    （半透明黑色遮罩 60% 透明度）   │
│                                  │
│       ┌──────────────────┐       │
│       │                  │       │
│       │    ┌────────┐    │       │
│       │    │ 小花老师 │    │       │
│       │    │ (微笑)  │    │       │
│       │    └────────┘    │       │
│       │                  │       │
│       │  "我在呢，请说~"  │       │
│       │                  │       │
│       │   ╭────────────╮ │       │
│       │   │ ○ ○ ○ ○ ○  │ │       │
│       │   │  等待波纹   │ │       │
│       │   ╰────────────╯ │       │
│       │                  │       │
│       │  [ 🎤 点击说话 ] │       │
│       │                  │       │
│       └──────────────────┘       │
│                                  │
│    点击空白区域关闭               │
└──────────────────────────────────┘
```

### 状态二：聆听态（Listening）

```
┌──────────────────────────────────┐
│          （当前页面内容）          │
│    （半透明黑色遮罩 60% 透明度）   │
│                                  │
│       ┌──────────────────┐       │
│       │                  │       │
│       │    ┌────────┐    │       │
│       │    │ 小花老师 │    │       │
│       │    │ (倾听)  │    │       │
│       │    └────────┘    │       │
│       │                  │       │
│       │ ┌──────────────┐ │       │
│       │ │ 实时识别文字  │ │       │
│       │ │ "这道数学题…" │ │       │
│       │ │ （光标闪烁）  │ │       │
│       │ └──────────────┘ │       │
│       │                  │       │
│       │   ╭────────────╮ │       │
│       │   │ ≋≋≋≋≋≋≋≋≋≋ │ │       │
│       │   │  声纹波动   │ │       │
│       │   ╰────────────╯ │       │
│       │                  │       │
│       │  [ 🔴 松开结束 ] │       │
│       │                  │       │
│       └──────────────────┘       │
│                                  │
└──────────────────────────────────┘
```

### 状态三：处理态（Processing）

```
┌──────────────────────────────────┐
│          （当前页面内容）          │
│    （半透明黑色遮罩 60% 透明度）   │
│                                  │
│       ┌──────────────────┐       │
│       │                  │       │
│       │    ┌────────┐    │       │
│       │    │ 小花老师 │    │       │
│       │    │ (思考)  │    │       │
│       │    └────────┘    │       │
│       │                  │       │
│       │ ┌──────────────┐ │       │
│       │ │ "这道数学题怎 │ │       │
│       │ │  么解？"      │ │       │
│       │ └──────────────┘ │       │
│       │                  │       │
│       │   ● ● ●          │       │
│       │   思考中...      │       │
│       │                  │       │
│       │                  │       │
│       └──────────────────┘       │
│                                  │
└──────────────────────────────────┘
```

### 状态四：回复态（Responding）

```
┌──────────────────────────────────┐
│          （当前页面内容）          │
│    （半透明黑色遮罩 60% 透明度）   │
│                                  │
│       ┌──────────────────┐       │
│       │                  │       │
│       │    ┌────────┐    │       │
│       │    │ 小花老师 │    │       │
│       │    │ (讲解)  │    │       │
│       │    └────────┘    │       │
│       │                  │       │
│       │ ┌──────────────┐ │       │
│       │ │ AI 回复文字   │ │       │
│       │ │ "这道题我们可 │ │       │
│       │ │  以用分步法…" │ │       │
│       │ │ （逐字显示）  │ │       │
│       │ └──────────────┘ │       │
│       │                  │       │
│       │  🔊 语音播放中   │       │
│       │  ━━━━━●━━━━ 0:12 │       │
│       │                  │       │
│       │ [继续提问] [结束] │       │
│       │                  │       │
│       └──────────────────┘       │
│                                  │
└──────────────────────────────────┘
```

## 元素说明

| 元素 | 类型 | 说明 |
|------|------|------|
| 遮罩层 | 背景 | 半透明黑色，透明度 60%，覆盖当前页面全部内容 |
| 浮层卡片 | 容器 | 宽度占屏幕 85%，圆角 20px，居中显示，白色背景，阴影投射 |
| 数字人形象 | 动态图像 | 尺寸 120x120pt，居中显示，支持表情切换动画 |
| 实时识别文字区 | 文本区域 | 字号 16pt，深灰色，最多显示 3 行，超出滚动 |
| 声纹波形 | 动画组件 | 宽度 200pt，高度 40pt，随音量实时波动 |
| 等待波纹 | 动画组件 | 5 个圆点，依次跳动，提示用户可以开始说话 |
| 麦克风按钮 | 按钮 | 直径 64pt，主题色填充，支持按住说话和点击说话两种模式 |
| AI 回复文字区 | 文本区域 | 字号 15pt，最大高度 200pt，超出可滚动 |
| 语音播放进度条 | 进度条 | 显示当前播放进度和总时长 |
| 继续提问按钮 | 主按钮 | 主题色，圆角 24px，点击回到聆听态 |
| 结束按钮 | 次要按钮 | 灰色边框，圆角 24px，点击关闭浮层 |

## 交互行为

### 手势交互
- **点击遮罩空白区域**：关闭浮层，回到当前页面（回复态播放中点击需二次确认）
- **按住麦克风按钮**：进入聆听态，松开后进入处理态（按住模式）
- **点击麦克风按钮**：进入聆听态，再次点击结束聆听进入处理态（点击模式）
- **上滑回复文字区**：滚动查看完整回复内容
- **下滑浮层卡片**：关闭浮层（从卡片顶部下滑触发）

### 输入交互
- **语音输入**：实时语音转文字（ASR），延迟不超过 300ms
- **语音唤醒**：用户说出"小花老师"唤醒词，自动弹出浮层并进入聆听态
- **静音检测**：聆听态下静音超过 3 秒自动结束聆听，进入处理态
- **噪音过滤**：自动过滤环境噪音，仅识别人声输入

### 动画与反馈
- **浮层弹出**：从底部滑入 + 淡入，时长 300ms，缓动曲线 ease-out
- **浮层关闭**：向下滑出 + 淡出，时长 250ms，缓动曲线 ease-in
- **唤醒态波纹**：5 个圆点依次上下跳动，循环播放，频率 1.2s/循环
- **聆听态声纹**：根据麦克风音量实时渲染波形，刷新率 30fps
- **处理态动画**：3 个圆点依次淡入淡出，频率 0.8s/循环
- **回复文字动画**：逐字显示，速度 60 字/秒，与语音播放同步
- **触觉反馈**：进入聆听态时轻触反馈（UIImpactFeedbackGenerator light）

### AI 老师交互
- **唤醒态**：微笑表情，眼睛注视用户，轻微点头动画
- **聆听态**：倾听表情，头部微微侧倾，眼睛随声纹波动微动
- **处理态**：思考表情，手托下巴，眼珠向上看
- **回复态 - 讲解**：认真表情，配合手势动画指向文字内容
- **回复态 - 鼓励**：开心表情，竖起大拇指（当回复内容为正向鼓励时）
- **回复态 - 引导**：温和表情，食指轻点（当引导学生思考时）
- **表情切换**：过渡时长 400ms，使用贝塞尔曲线平滑切换

## 状态枚举

### 默认状态（唤醒态）
- 浮层弹出后的初始状态
- 数字人微笑等待
- 显示提示文字："我在呢，请说~"
- 麦克风按钮高亮可点击

### 聆听态
- 声纹波形实时波动
- 实时识别文字逐字显示
- 识别文字区光标闪烁
- 麦克风按钮变为红色录制状态

### 处理态
- 三点跳动动画
- 显示已识别的完整文字
- 麦克风按钮置灰不可操作
- 超过 5 秒显示"小花老师正在认真思考中…"

### 回复态
- 文字逐字显示 + 语音同步播放
- 播放进度条显示进度
- 底部显示"继续提问"和"结束"按钮

### 错误状态
- **语音识别失败**：显示"没听清楚，请再说一次~"，自动回到唤醒态
- **网络异常**：显示"网络不太好，请检查后再试"，提供重试按钮
- **AI 回复失败**：显示"小花老师开小差了，再问一次吧~"，提供重试按钮
- **麦克风权限未授权**：跳转至 G2 权限请求弹窗

### 边界情况
- **超长语音输入**：最长支持 60 秒，到达 50 秒时提示"还有 10 秒哦"
- **超长回复内容**：回复文字区可滚动，语音播放完整
- **快速连续唤醒**：防抖处理，500ms 内多次触发仅响应一次
- **后台切换**：App 进入后台时暂停聆听，回到前台恢复唤醒态
- **来电打断**：自动暂停当前状态，通话结束后恢复

## 导航关系

### 从哪来
- **任意页面**：点击右下角 AI 老师悬浮气泡触发
- **任意页面**：语音唤醒词"小花老师"触发
- **特定功能页**：点击"问小花老师"按钮触发（如拍照批改结果页、知识点详情页）

### 到哪去
- **当前页面**：关闭浮层后停留在原页面
- **G2 权限请求弹窗**：麦克风未授权时跳转
- **相关知识点页面**：当 AI 回复中包含知识点链接时，点击可跳转
- **拍照上传页**：当 AI 建议拍照上传题目时，点击可跳转
